<!DOCTYPE html>
<script type="text/javascript">

	function performCommand(event) {
		if (event.command === "search_oed_for_phrase") {
			var libraryCardNum = safari.extension.settings.getItem('libraryCardNumber');			
      // console.log("Library card number: ", libraryCardNum);
			if (libraryCardNum) {
        // console.log("About to send the login request.");
        // The library login request must have a 'dest' value in the post request that resolves to a valid resource in the OED site.
				sendRequest('http://www.oed.com/LIBRARY', function(req){console.log(req.responseText);doOEDSearch(event.userInfo);}, 'lib_card='+libraryCardNum+'&dest=/');
			} else {
        // console.log('Skipping libraryCardNum and going straight to search');
				doOEDSearch(event.userInfo);
			}
		}
	}
	
	function performValidate(event) {
    if (event.command === "search_oed_for_phrase") {
			var phrase = event.userInfo;
 	  	if (!phrase || phrase.length == 0) {
	    	event.target.disabled = true;
	   	} else if (phrase.length > 25) {
	   		phrase = phrase.substr(0,25);
	   		phrase = phrase + '...';
			}
	   	event.target.title = 'Look Up "' + phrase + '" in OED';
		}
	}
	safari.application.addEventListener("command", performCommand, false);
	safari.application.addEventListener("validate", performValidate, false);
	
	function doOEDSearch(phrase) {
    // console.log("Searching for", phrase);
		var url = "http://www.oed.com/search?q=" + phrase;

		var tab = safari.application.activeBrowserWindow.openTab("foreground");
    tab.url = url;
	}
	
	// http://quirksmode.org/js/xmlhttp.html
	function sendRequest(url, callback, postData) {
		var req = new XMLHttpRequest();
		if (!req) return;
		var method = (postData) ? "POST" : "GET";
		req.open(method,url,true);
		if (postData)
			req.setRequestHeader('Content-type','application/x-www-form-urlencoded');
		req.onreadystatechange = function () {
			if (req.readyState != 4) return;
			if (req.status != 200 && req.status != 304) {
	//			alert('HTTP error ' + req.status);
				return;
			}
			callback(req);
		};
		if (req.readyState == 4) return;
		req.send(postData);
	}	
	
</script>
